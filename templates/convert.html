{% extends "base.html" %}

{% block title %}æ¨¡å‹è½¬æ¢ - BXC_VideoNet{% endblock %}

{% block content %}
<div id="message-container"></div>

<!-- é€‰æ‹©æ¨¡å‹ -->
<div class="card">
    <h2 class="card-title">ğŸ”„ é€‰æ‹©è®­ç»ƒæ¨¡å‹</h2>
    <div class="form-group">
        <label class="form-label">é€‰æ‹©è¦è½¬æ¢çš„æ¨¡å‹</label>
        <select id="model-select" class="form-select">
            <option value="">-- è¯·é€‰æ‹©æ¨¡å‹ --</option>
        </select>
    </div>
    <div id="model-info" style="display: none; margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 6px; font-size: 13px;">
        <p style="margin: 4px 0;"><strong>æ–‡ä»¶åï¼š</strong><span id="info-name"></span></p>
        <p style="margin: 4px 0;"><strong>å¤§å°ï¼š</strong><span id="info-size"></span></p>
        <p style="margin: 4px 0;"><strong>åˆ›å»ºæ—¶é—´ï¼š</strong><span id="info-created"></span></p>
    </div>
</div>

<!-- è½¬æ¢é…ç½® -->
<div class="card">
    <h2 class="card-title">âš™ï¸ è½¬æ¢é…ç½®</h2>
    
    <div class="form-group">
        <label class="form-label">ç›®æ ‡æ ¼å¼</label>
        <div style="display: flex; gap: 15px; margin-top: 8px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="format" value="onnx" checked style="margin-right: 6px;">
                <span style="font-size: 14px;">ONNX æ ¼å¼</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="format" value="openvino" style="margin-right: 6px;">
                <span style="font-size: 14px;">OpenVINO æ ¼å¼</span>
            </label>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 6px;">
            ğŸ’¡ ONNXæ ¼å¼ç”¨äºè·¨å¹³å°éƒ¨ç½²ï¼ŒOpenVINOæ ¼å¼ç”¨äºIntelå¹³å°ä¼˜åŒ–æ¨ç†
        </p>
    </div>
    
    <div class="form-group" id="dynamic-input-group">
        <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="dynamic-input" style="margin-right: 6px;">
            <span class="form-label" style="margin: 0;">å¯ç”¨åŠ¨æ€è¾“å…¥ç»´åº¦ï¼ˆä»…ONNXï¼‰</span>
        </label>
        <p style="font-size: 12px; color: #666; margin-top: 6px;">
            æ”¯æŒä¸åŒæ‰¹æ¬¡å¤§å°å’Œå¸§æ•°çš„è§†é¢‘è¾“å…¥
        </p>
    </div>
    
    <button id="convert-btn" class="btn btn-primary" style="width: 100%;">
        ğŸš€ å¼€å§‹è½¬æ¢
    </button>
</div>

<!-- è½¬æ¢æ—¥å¿— -->
<div class="card">
    <h2 class="card-title">ğŸ“‹ è½¬æ¢æ—¥å¿—</h2>
    <div id="convert-log" class="log-box" style="min-height: 150px;">
        ç­‰å¾…å¼€å§‹è½¬æ¢...
    </div>
</div>

<!-- å·²è½¬æ¢æ¨¡å‹åˆ—è¡¨ -->
<div class="card">
    <h2 class="card-title">ğŸ“¦ å·²è½¬æ¢æ¨¡å‹</h2>
    <button id="refresh-converted-btn" class="btn btn-secondary" style="margin-bottom: 10px;">
        ğŸ”„ åˆ·æ–°åˆ—è¡¨
    </button>
    <div id="converted-models-list"></div>
</div>

<script>
let allModels = [];
let isConverting = false;

// é¡µé¢åŠ è½½æ—¶è·å–æ¨¡å‹åˆ—è¡¨
document.addEventListener('DOMContentLoaded', () => {
    loadModels();
    loadConvertedModels();
    
    // ç›‘å¬æ ¼å¼é€‰æ‹©å˜åŒ–
    document.querySelectorAll('input[name="format"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const dynamicInputGroup = document.getElementById('dynamic-input-group');
            if (e.target.value === 'onnx') {
                dynamicInputGroup.style.display = 'block';
            } else {
                dynamicInputGroup.style.display = 'none';
            }
        });
    });
});

// åŠ è½½æ¨¡å‹åˆ—è¡¨
async function loadModels() {
    try {
        const response = await fetch('/api/models/list');
        const data = await response.json();
        
        allModels = data.models || [];
        const select = document.getElementById('model-select');
        select.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ¨¡å‹ --</option>';
        
        allModels.forEach((model, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = model.name;
            select.appendChild(option);
        });
        
        // ç›‘å¬é€‰æ‹©å˜åŒ–
        select.addEventListener('change', (e) => {
            const index = e.target.value;
            if (index !== '') {
                const model = allModels[index];
                showModelInfo(model);
            } else {
                document.getElementById('model-info').style.display = 'none';
            }
        });
        
    } catch (error) {
        showMessage('error', 'åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯
function showModelInfo(model) {
    document.getElementById('info-name').textContent = model.name;
    document.getElementById('info-size').textContent = model.size;
    document.getElementById('info-created').textContent = model.created;
    document.getElementById('model-info').style.display = 'block';
}

// å¼€å§‹è½¬æ¢
document.getElementById('convert-btn').addEventListener('click', async () => {
    if (isConverting) {
        showMessage('error', 'è½¬æ¢æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™');
        return;
    }
    
    const selectIndex = document.getElementById('model-select').value;
    if (!selectIndex) {
        showMessage('error', 'è¯·å…ˆé€‰æ‹©è¦è½¬æ¢çš„æ¨¡å‹');
        return;
    }
    
    const selectedModel = allModels[selectIndex];
    const format = document.querySelector('input[name="format"]:checked').value;
    const dynamicInput = document.getElementById('dynamic-input').checked;
    
    isConverting = true;
    document.getElementById('convert-btn').disabled = true;
    document.getElementById('convert-btn').textContent = 'ğŸ”„ è½¬æ¢ä¸­...';
    
    // æ¸…ç©ºæ—¥å¿—
    const logBox = document.getElementById('convert-log');
    logBox.innerHTML = `å¼€å§‹è½¬æ¢æ¨¡å‹: ${selectedModel.name}
ç›®æ ‡æ ¼å¼: ${format.toUpperCase()}
åŠ¨æ€è¾“å…¥: ${dynamicInput ? 'å¯ç”¨' : 'ç¦ç”¨'}

æ­£åœ¨å¤„ç†...
`;
    
    try {
        const response = await fetch('/api/models/convert', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                model_name: selectedModel.name,
                output_format: format,
                dynamic_input: dynamicInput
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            logBox.innerHTML += `\nâœ… è½¬æ¢æˆåŠŸï¼\n`;
            logBox.innerHTML += `è¾“å‡ºæ ¼å¼: ${result.format}\n`;
            if (result.output_file) {
                logBox.innerHTML += `è¾“å‡ºæ–‡ä»¶: ${result.output_file}\n`;
            } else if (result.output_dir) {
                logBox.innerHTML += `è¾“å‡ºç›®å½•: ${result.output_dir}\n`;
            }
            showMessage('success', result.message);
            
            // åˆ·æ–°å·²è½¬æ¢æ¨¡å‹åˆ—è¡¨
            setTimeout(() => loadConvertedModels(), 500);
        } else {
            logBox.innerHTML += `\nâŒ è½¬æ¢å¤±è´¥: ${result.message}\n`;
            showMessage('error', result.message);
        }
        
    } catch (error) {
        logBox.innerHTML += `\nâŒ è½¬æ¢å¤±è´¥: ${error.message}\n`;
        showMessage('error', 'è½¬æ¢å¤±è´¥: ' + error.message);
    } finally {
        isConverting = false;
        document.getElementById('convert-btn').disabled = false;
        document.getElementById('convert-btn').textContent = 'ğŸš€ å¼€å§‹è½¬æ¢';
    }
});

// åŠ è½½å·²è½¬æ¢çš„æ¨¡å‹
async function loadConvertedModels() {
    try {
        const response = await fetch('/api/models/list');
        const data = await response.json();
        
        const models = data.models || [];
        const container = document.getElementById('converted-models-list');
        
        // ç­›é€‰å‡ºONNXå’ŒOpenVINOæ¨¡å‹
        const onnxModels = models.filter(m => m.name.endsWith('.onnx'));
        const openvinoModels = models.filter(m => m.name.includes('_openvino'));
        
        if (onnxModels.length === 0 && openvinoModels.length === 0) {
            container.innerHTML = '<p style="color: #999; font-size: 14px;">æš‚æ— å·²è½¬æ¢çš„æ¨¡å‹</p>';
            return;
        }
        
        let html = '<div style="display: grid; gap: 12px;">';
        
        // ONNXæ¨¡å‹
        if (onnxModels.length > 0) {
            html += '<h3 style="font-size: 15px; color: #667eea; margin-top: 10px;">ONNX æ¨¡å‹</h3>';
            onnxModels.forEach(model => {
                html += `
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border-left: 3px solid #667eea;">
                        <p style="margin: 4px 0; font-weight: 600; font-size: 14px;">${model.name}</p>
                        <p style="margin: 4px 0; font-size: 13px; color: #666;">å¤§å°: ${model.size} | åˆ›å»º: ${model.created}</p>
                    </div>
                `;
            });
        }
        
        // OpenVINOæ¨¡å‹ï¼ˆæ˜¾ç¤ºç›®å½•ï¼‰
        if (openvinoModels.length > 0) {
            html += '<h3 style="font-size: 15px; color: #56ab2f; margin-top: 10px;">OpenVINO æ¨¡å‹</h3>';
            openvinoModels.forEach(model => {
                html += `
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; border-left: 3px solid #56ab2f;">
                        <p style="margin: 4px 0; font-weight: 600; font-size: 14px;">${model.name}</p>
                        <p style="margin: 4px 0; font-size: 13px; color: #666;">åˆ›å»º: ${model.created}</p>
                    </div>
                `;
            });
        }
        
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('åŠ è½½å·²è½¬æ¢æ¨¡å‹å¤±è´¥:', error);
    }
}

// åˆ·æ–°æŒ‰é’®
document.getElementById('refresh-converted-btn').addEventListener('click', loadConvertedModels);

// æ¶ˆæ¯æç¤ºå‡½æ•°
function showMessage(type, message) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message message-${type} show`;
    msgDiv.textContent = message;
    
    const container = document.getElementById('message-container');
    container.appendChild(msgDiv);
    
    setTimeout(() => {
        msgDiv.remove();
    }, 5000);
}
</script>

<style>
/* å•é€‰æ¡†å’Œå¤é€‰æ¡†æ ·å¼ä¼˜åŒ– */
input[type="radio"], input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

#message-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    max-width: 400px;
}
</style>

{% endblock %}
