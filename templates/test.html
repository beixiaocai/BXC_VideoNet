{% extends "base.html" %}

{% block title %}æ¨¡å‹æµ‹è¯• - BXC_VideoNet{% endblock %}

{% block content %}
<div class="card">
    <h2 class="card-title">ğŸ§ª æ¨¡å‹æµ‹è¯•</h2>
    <p style="margin-bottom: 12px; color: #666; font-size: 11px;">
        ä¸Šä¼ è§†é¢‘ç‰‡æ®µï¼Œä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹
    </p>

    <div class="form-group">
        <label class="form-label">é€‰æ‹©æ¨¡å‹</label>
        <select id="test-model" class="form-select">
            <option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>
        </select>
    </div>

    <div class="file-upload" id="test-upload-area">
        <div class="file-upload-icon">ğŸ¥</div>
        <h3 style="margin-bottom: 6px; font-size: 13px;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æµ‹è¯•è§†é¢‘</h3>
        <p style="color: #666; font-size: 11px;">æ”¯æŒ .mp4, .avi, .mov æ ¼å¼</p>
        <input type="file" id="test-video-file" accept=".mp4,.avi,.mov" style="display: none;">
    </div>

    <div id="selected-video" style="margin-top: 12px;"></div>

    <button class="btn btn-primary" id="predict-btn" style="margin-top: 8px;" disabled>
        ğŸ”® å¼€å§‹é¢„æµ‹
    </button>
</div>

<div class="card" id="result-card" style="display: none;">
    <h2 class="card-title">ğŸ“Š é¢„æµ‹ç»“æœ</h2>
    
    <div class="grid-item" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 15px; padding: 15px;">
        <h3 style="margin-bottom: 10px; font-size: 13px;">é¢„æµ‹ç±»åˆ«</h3>
        <p style="font-size: 28px; font-weight: bold; margin: 12px 0;" id="predicted-class">-</p>
        <p style="font-size: 14px; opacity: 0.9;">
            ç½®ä¿¡åº¦: <span id="confidence" style="font-weight: bold;">0%</span>
        </p>
    </div>

    <h3 style="margin-bottom: 10px; color: #333; font-size: 13px;">Top 5 é¢„æµ‹æ¦‚ç‡</h3>
    <div id="top5-results"></div>
</div>

<div class="card">
    <h2 class="card-title">ğŸ“ˆ æµ‹è¯•å†å²</h2>
    <div id="test-history">
        <p style="text-align: center; color: #999; padding: 12px; font-size: 11px;">æš‚æ— æµ‹è¯•è®°å½•</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let selectedTestFile = null;
    let testHistory = [];

    // é¡µé¢åŠ è½½æ—¶è·å–æ¨¡å‹åˆ—è¡¨
    window.addEventListener('load', () => {
        loadTestModels();
        loadTestHistory();
    });

    // åŠ è½½æ¨¡å‹åˆ—è¡¨
    function loadTestModels() {
        request('/api/models/list')
            .then(data => {
                const modelSelect = document.getElementById('test-model');
                modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>';
                
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (${model.size})`;
                    modelSelect.appendChild(option);
                });
            });
    }

    // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
    const testUploadArea = document.getElementById('test-upload-area');
    const testFileInput = document.getElementById('test-video-file');

    testUploadArea.addEventListener('click', () => {
        testFileInput.click();
    });

    testUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        testUploadArea.style.background = 'rgba(102, 126, 234, 0.2)';
    });

    testUploadArea.addEventListener('dragleave', () => {
        testUploadArea.style.background = 'rgba(102, 126, 234, 0.05)';
    });

    testUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        testUploadArea.style.background = 'rgba(102, 126, 234, 0.05)';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    testFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    function handleFileSelect(file) {
        if (!file.name.match(/\.(mp4|avi|mov)$/i)) {
            showMessage('error', 'è¯·é€‰æ‹©æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶ï¼ˆ.mp4, .avi, .movï¼‰');
            return;
        }

        selectedTestFile = file;
        
        const selectedDiv = document.getElementById('selected-video');
        selectedDiv.innerHTML = `
            <div style="background: white; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 11px;">
                <div>
                    <strong>ğŸ“¹ ${file.name}</strong>
                    <p style="color: #999; margin-top: 3px;">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
                <button class="btn btn-secondary" onclick="clearSelectedFile()" style="padding: 5px 12px; font-size: 10px;">æ¸…é™¤</button>
            </div>
        `;

        updatePredictButton();
    }

    function clearSelectedFile() {
        selectedTestFile = null;
        document.getElementById('selected-video').innerHTML = '';
        testFileInput.value = '';
        updatePredictButton();
    }

    // æ¨¡å‹é€‰æ‹©å˜åŒ–
    document.getElementById('test-model').addEventListener('change', () => {
        updatePredictButton();
    });

    function updatePredictButton() {
        const btn = document.getElementById('predict-btn');
        const model = document.getElementById('test-model').value;
        btn.disabled = !(selectedTestFile && model);
    }

    // å¼€å§‹é¢„æµ‹
    document.getElementById('predict-btn').addEventListener('click', () => {
        const modelName = document.getElementById('test-model').value;
        
        if (!selectedTestFile || !modelName) {
            showMessage('error', 'è¯·é€‰æ‹©æ¨¡å‹å’Œæµ‹è¯•è§†é¢‘');
            return;
        }

        const btn = document.getElementById('predict-btn');
        btn.disabled = true;
        btn.textContent = 'ğŸ”„ é¢„æµ‹ä¸­...';

        const formData = new FormData();
        formData.append('video', selectedTestFile);
        formData.append('model_name', modelName);

        fetch('/api/test/predict', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            btn.disabled = false;
            btn.textContent = 'ğŸ”® å¼€å§‹é¢„æµ‹';

            if (result.success) {
                showMessage('success', 'é¢„æµ‹å®Œæˆï¼');
                displayResult(result.result);
                
                // æ·»åŠ åˆ°å†å²è®°å½•
                addToHistory({
                    video: selectedTestFile.name,
                    model: modelName,
                    result: result.result,
                    time: new Date().toLocaleString()
                });
            } else {
                showMessage('error', result.message);
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.textContent = 'ğŸ”® å¼€å§‹é¢„æµ‹';
            showMessage('error', 'é¢„æµ‹å¤±è´¥: ' + error.message);
        });
    });

    // æ˜¾ç¤ºé¢„æµ‹ç»“æœ
    function displayResult(result) {
        document.getElementById('result-card').style.display = 'block';
        document.getElementById('predicted-class').textContent = result.predicted_class;
        document.getElementById('confidence').textContent = (result.confidence * 100).toFixed(2) + '%';

        // æ˜¾ç¤º Top 5
        let top5Html = '';
        result.top5.forEach((item, idx) => {
            const percentage = (item.probability * 100).toFixed(2);
            const barColor = idx === 0 ? '#667eea' : '#a8b8ea';
            
            top5Html += `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">
                        <strong>${idx + 1}. ${item.class}</strong>
                        <span>${percentage}%</span>
                    </div>
                    <div style="background: #e0e0e0; border-radius: 8px; height: 16px; overflow: hidden;">
                        <div style="background: ${barColor}; height: 100%; width: ${percentage}%; transition: width 0.5s;"></div>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('top5-results').innerHTML = top5Html;

        // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
        document.getElementById('result-card').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // æ·»åŠ åˆ°å†å²è®°å½•
    function addToHistory(record) {
        testHistory.unshift(record);
        
        // åªä¿ç•™æœ€è¿‘10æ¡
        if (testHistory.length > 10) {
            testHistory = testHistory.slice(0, 10);
        }
        
        loadTestHistory();
    }

    // åŠ è½½æµ‹è¯•å†å²
    function loadTestHistory() {
        const historyDiv = document.getElementById('test-history');
        
        if (testHistory.length === 0) {
            historyDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 12px; font-size: 11px;">æš‚æ— æµ‹è¯•è®°å½•</p>';
            return;
        }

        let html = '<table class="table"><thead><tr><th>æ—¶é—´</th><th>è§†é¢‘</th><th>æ¨¡å‹</th><th>é¢„æµ‹ç»“æœ</th><th>ç½®ä¿¡åº¦</th></tr></thead><tbody>';
        
        testHistory.forEach(record => {
            html += `<tr>
                <td>${record.time}</td>
                <td>${record.video}</td>
                <td style="font-size: 12px;">${record.model}</td>
                <td><strong>${record.result.predicted_class}</strong></td>
                <td>${(record.result.confidence * 100).toFixed(2)}%</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
        historyDiv.innerHTML = html;
    }
</script>
{% endblock %}
