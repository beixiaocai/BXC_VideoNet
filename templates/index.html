{% extends "base.html" %}

{% block title %}æ•°æ®é›†ç®¡ç† - BXC_VideoNet{% endblock %}

{% block content %}
<div class="card">
    <h2 class="card-title">ğŸ“Š æ•°æ®é›†ç»Ÿè®¡</h2>
    <div class="grid">
        <div class="stat-card">
            <div class="stat-label">è®­ç»ƒé›†è§†é¢‘æ•°</div>
            <div class="stat-number" id="train-count">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);">
            <div class="stat-label">éªŒè¯é›†è§†é¢‘æ•°</div>
            <div class="stat-number" id="val-count">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="stat-label">ç±»åˆ«æ•°</div>
            <div class="stat-number" id="class-count">0</div>
        </div>
    </div>

    <div id="class-details" style="margin-top: 12px;"></div>
</div>

<div class="card">
    <h2 class="card-title">ğŸ“ ç±»åˆ«ç®¡ç† & ä¸Šä¼ è§†é¢‘</h2>
    <p style="margin-bottom: 12px; color: #666; font-size: 11px;">
        <strong>æ“ä½œæ­¥éª¤ï¼š</strong>â‘  åˆ›å»ºç±»åˆ«æ–‡ä»¶å¤¹ â†’ â‘¡ ç‚¹å‡»ç±»åˆ«å¡ç‰‡é€‰ä¸­ â†’ â‘¢ æ‹–å…¥æˆ–é€‰æ‹©è§†é¢‘æ–‡ä»¶ä¸Šä¼ 
    </p>

    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <input type="text" id="new-category-name" class="form-input" placeholder="è¾“å…¥ç±»åˆ«åç§°ï¼ˆå¦‚ï¼šBasketballï¼‰" style="flex: 1;">
        <button class="btn btn-success" id="create-category-btn">
            â• åˆ›å»ºç±»åˆ«
        </button>
    </div>

    <div id="categories-list" style="margin-bottom: 12px;"></div>

    <div class="file-upload" id="upload-area">
        <div class="file-upload-icon">ğŸ“¹</div>
        <h3 style="margin-bottom: 6px; font-size: 13px;">ç‚¹å‡»é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼Œæˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</h3>
        <p style="color: #666; font-size: 11px;">æ”¯æŒ .mp4, .avi, .mov æ ¼å¼ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ 500MB</p>
        <p style="color: #667eea; font-weight: bold; margin-top: 6px; font-size: 11px;">âœ¨ æ”¯æŒå¤šæ–‡ä»¶åŒæ—¶ä¸Šä¼ ï¼Œæé€Ÿé«˜æ•ˆï¼</p>
        <p id="selected-category-hint" style="margin-top: 8px; color: #dc3545; font-weight: bold; font-size: 11px; display: none;"></p>
        <input type="file" id="video-file" accept=".mp4,.avi,.mov" style="display: none;" multiple>
    </div>

    <div id="upload-list" style="margin-top: 12px;"></div>

    <button class="btn btn-primary" id="upload-btn" style="margin-top: 8px;" disabled>
        å¼€å§‹ä¸Šä¼ 
    </button>
</div>

<div class="card">
    <h2 class="card-title">âœ‚ï¸ åˆ†å‰²æ•°æ®é›†</h2>
    <p style="margin-bottom: 12px; color: #666; font-size: 11px;">
        å°†ä¸Šä¼ çš„è§†é¢‘æŒ‰ç…§æŒ‡å®šæ¯”ä¾‹åˆ†å‰²ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å„ç±»åˆ«çš„è§†é¢‘åˆ†åˆ«åˆ†é…åˆ° train/ å’Œ val/ ç›®å½•
    </p>

    <div class="form-group">
        <label class="form-label">è®­ç»ƒé›†æ¯”ä¾‹</label>
        <input type="range" id="split-ratio" min="0.5" max="0.95" step="0.05" value="0.8" 
               style="width: 100%;" oninput="document.getElementById('ratio-value').textContent = (this.value * 100).toFixed(0) + '%'">
        <div style="text-align: center; margin-top: 6px; font-size: 18px; font-weight: bold; color: #667eea;">
            <span id="ratio-value">80%</span>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">éšæœºç§å­ï¼ˆç”¨äºå¯é‡å¤æ€§ï¼‰</label>
        <input type="number" id="split-seed" class="form-input" value="42">
    </div>

    <div style="display: flex; gap: 8px;">
        <button class="btn btn-success" id="split-btn">
            ğŸ”„ å¼€å§‹åˆ†å‰²
        </button>
        <button class="btn btn-danger" id="clear-uploads-btn">
            ğŸ—‘ï¸ æ¸…ç©ºä¸Šä¼ ç›®å½•
        </button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let selectedFiles = [];
    let selectedCategory = null;  // å½“å‰é€‰ä¸­çš„ç±»åˆ«

    // é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡ä¿¡æ¯å’Œç±»åˆ«åˆ—è¡¨
    window.addEventListener('load', () => {
        loadStats();
        loadCategories();
    });

    // åŠ è½½æ•°æ®é›†ç»Ÿè®¡
    function loadStats() {
        request('/api/dataset/stats')
            .then(data => {
                document.getElementById('train-count').textContent = data.total_train || 0;
                document.getElementById('val-count').textContent = data.total_val || 0;
                document.getElementById('class-count').textContent = data.classes.length || 0;

                // æ˜¾ç¤ºç±»åˆ«è¯¦æƒ…ï¼ˆç´§å‡‘æ ·å¼ï¼‰
                if (data.classes.length > 0) {
                    let html = '<table class="table"><thead><tr><th>ç±»åˆ«åç§°</th><th>è®­ç»ƒé›†</th><th>éªŒè¯é›†</th><th>æ€»è®¡</th></tr></thead><tbody>';
                    data.classes.forEach(cls => {
                        html += `<tr>
                            <td><strong>${cls.name}</strong></td>
                            <td>${cls.train}</td>
                            <td>${cls.val}</td>
                            <td>${cls.train + cls.val}</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    document.getElementById('class-details').innerHTML = html;
                } else {
                    document.getElementById('class-details').innerHTML = '<p style="text-align: center; color: #999; padding: 12px; font-size: 11px;">æš‚æ— æ•°æ®é›†ï¼Œè¯·å…ˆä¸Šä¼ è§†é¢‘</p>';
                }
            });
    }

    // åŠ è½½ç±»åˆ«åˆ—è¡¨
    function loadCategories() {
        request('/api/categories/list')
            .then(data => {
                const categoriesList = document.getElementById('categories-list');
                
                if (data.categories.length === 0) {
                    categoriesList.innerHTML = '<p style="text-align: center; color: #999; padding: 15px; font-size: 13px;">æš‚æ— ç±»åˆ«ï¼Œè¯·å…ˆåˆ›å»ºç±»åˆ«æ–‡ä»¶å¤¹</p>';
                    return;
                }

                // æ›´æ–°ç±»åˆ«åˆ—è¡¨æ˜¾ç¤ºï¼ˆç´§å‡‘å¸ƒå±€ï¼‰
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;">';
                data.categories.forEach(cat => {
                    const isSelected = selectedCategory === cat.name;
                    html += `
                        <div class="category-card" data-category="${cat.name}" 
                             style="background: ${isSelected ? '#e7f3ff' : 'white'}; 
                                    padding: 10px; 
                                    border-radius: 6px; 
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.06); 
                                    position: relative; 
                                    cursor: pointer;
                                    border: 2px solid ${isSelected ? '#667eea' : 'transparent'};
                                    transition: all 0.3s;"
                             onclick="selectCategory('${cat.name}')">
                            <button onclick="event.stopPropagation(); deleteCategory('${cat.name}');" 
                                    style="position: absolute; top: 3px; right: 3px; background: #dc3545; color: white; border: none; border-radius: 3px; padding: 2px 5px; cursor: pointer; font-size: 9px;">åˆ é™¤</button>
                            <div style="font-size: 24px; text-align: center; margin-bottom: 4px;">ğŸ“</div>
                            <h4 style="text-align: center; margin-bottom: 4px; font-size: 11px; font-weight: 600;">${cat.name}</h4>
                            <p style="text-align: center; color: #666; font-size: 10px;">${cat.video_count} ä¸ªè§†é¢‘</p>
                        </div>
                    `;
                });
                html += '</div>';
                categoriesList.innerHTML = html;

                updateUploadButton();
            });
    }

    // é€‰ä¸­ç±»åˆ«
    function selectCategory(categoryName) {
        selectedCategory = categoryName;
        
        // æ›´æ–°æ‰€æœ‰ç±»åˆ«å¡ç‰‡çš„æ ·å¼
        document.querySelectorAll('.category-card').forEach(card => {
            const cardCategory = card.getAttribute('data-category');
            if (cardCategory === categoryName) {
                card.style.background = '#e7f3ff';
                card.style.border = '2px solid #667eea';
                card.style.transform = 'scale(1.05)';
            } else {
                card.style.background = 'white';
                card.style.border = '2px solid transparent';
                card.style.transform = 'scale(1)';
            }
        });

        // æ›´æ–°æç¤ºä¿¡æ¯
        const hint = document.getElementById('selected-category-hint');
        hint.textContent = `å·²é€‰ä¸­ç±»åˆ«ï¼š${categoryName}`;
        hint.style.display = 'block';

        updateUploadButton();
    }

    // åˆ›å»ºç±»åˆ«
    document.getElementById('create-category-btn').addEventListener('click', () => {
        const categoryName = document.getElementById('new-category-name').value.trim();
        
        if (!categoryName) {
            showMessage('error', 'è¯·è¾“å…¥ç±»åˆ«åç§°');
            return;
        }

        request('/api/categories/create', {
            method: 'POST',
            body: JSON.stringify({ name: categoryName })
        }).then(result => {
            if (result.success) {
                showMessage('success', result.message);
                document.getElementById('new-category-name').value = '';
                loadCategories();
            } else {
                showMessage('error', result.message);
            }
        });
    });

    // åˆ é™¤ç±»åˆ«
    function deleteCategory(categoryName) {
        if (confirm(`ç¡®å®šè¦åˆ é™¤ç±»åˆ« "${categoryName}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¼šåˆ é™¤è¯¥ç±»åˆ«ä¸‹çš„æ‰€æœ‰è§†é¢‘æ–‡ä»¶ï¼`)) {
            request('/api/categories/delete', {
                method: 'POST',
                body: JSON.stringify({ name: categoryName })
            }).then(result => {
                if (result.success) {
                    showMessage('success', result.message);
                    loadCategories();
                } else {
                    showMessage('error', result.message);
                }
            });
        }
    }

    // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('video-file');

    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸæ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // æ‹–æ‹½ç›¸å…³äº‹ä»¶
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.background = 'rgba(102, 126, 234, 0.2)';
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.background = 'rgba(102, 126, 234, 0.05)';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.background = 'rgba(102, 126, 234, 0.05)';
        
        const files = Array.from(e.dataTransfer.files).filter(f => 
            f.name.toLowerCase().endsWith('.mp4') || 
            f.name.toLowerCase().endsWith('.avi') || 
            f.name.toLowerCase().endsWith('.mov')
        );
        
        if (files.length > 0) {
            selectedFiles = files;
            displayFileList();
        } else {
            showMessage('error', 'è¯·æ‹–å…¥æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶ï¼ˆ.mp4, .avi, .movï¼‰');
        }
    });

    // æ–‡ä»¶é€‰æ‹©å˜åŒ–
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            selectedFiles = files;
            displayFileList();
        }
    });

    function updateUploadButton() {
        const btn = document.getElementById('upload-btn');
        btn.disabled = !selectedCategory || selectedFiles.length === 0;
    }

    function displayFileList() {
        const listDiv = document.getElementById('upload-list');
        if (selectedFiles.length === 0) {
            listDiv.innerHTML = '';
            updateUploadButton();
            return;
        }

        let html = '<h4 style="margin-bottom: 6px; font-size: 11px;">å·²é€‰æ‹© ' + selectedFiles.length + ' ä¸ªæ–‡ä»¶ï¼š</h4><ul style="list-style: none;" id="file-list">';
        selectedFiles.forEach((file, idx) => {
            html += `<li id="file-${idx}" style="padding: 4px 8px; background: white; margin-bottom: 3px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 10px;">
                <span>ğŸ“¹ ${file.name}</span>
                <span style="color: #999;">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
            </li>`;
        });
        html += '</ul>';
        listDiv.innerHTML = html;
        updateUploadButton();
    }

    // ä¸Šä¼ è§†é¢‘ï¼ˆå¹¶è¡Œä¸Šä¼ ä¼˜åŒ– + å®æ—¶è¿›åº¦ï¼‰
    document.getElementById('upload-btn').addEventListener('click', async () => {
        if (!selectedCategory) {
            showMessage('error', 'è¯·å…ˆç‚¹å‡»é€‰ä¸­ä¸€ä¸ªç±»åˆ«æ–‡ä»¶å¤¹');
            return;
        }

        if (selectedFiles.length === 0) {
            showMessage('error', 'è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶');
            return;
        }

        const btn = document.getElementById('upload-btn');
        btn.disabled = true;
        btn.textContent = 'ä¸Šä¼ ä¸­...';

        // å¹¶è¡Œä¸Šä¼ æ‰€æœ‰æ–‡ä»¶ï¼Œå¹¶æ˜¾ç¤ºå®æ—¶è¿›åº¦
        const uploadPromises = selectedFiles.map((file, index) => {
            const formData = new FormData();
            formData.append('video', file);
            formData.append('category', selectedCategory);

            // æ›´æ–°æ–‡ä»¶çŠ¶æ€ä¸ºä¸Šä¼ ä¸­
            const fileItem = document.getElementById(`file-${index}`);
            if (fileItem) {
                fileItem.style.background = '#fff3cd';
                fileItem.innerHTML = `
                    <span style="font-size: 12px;">ğŸ”„ ${file.name}</span>
                    <span style="color: #856404; font-size: 11px;">ä¸Šä¼ ä¸­...</span>
                `;
            }

            return fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                // æ›´æ–°æ–‡ä»¶çŠ¶æ€
                if (fileItem) {
                    if (result.success) {
                        fileItem.style.background = '#d4edda';
                        fileItem.innerHTML = `
                            <span style="font-size: 10px;">âœ… ${file.name}</span>
                            <span style="color: #155724; font-size: 9px;">ä¸Šä¼ æˆåŠŸ</span>
                        `;
                    } else {
                        fileItem.style.background = '#f8d7da';
                        fileItem.innerHTML = `
                            <span style="font-size: 10px;">âŒ ${file.name}</span>
                            <span style="color: #721c24; font-size: 9px;">ä¸Šä¼ å¤±è´¥</span>
                        `;
                    }
                }
                return { success: result.success, filename: file.name };
            })
            .catch(error => {
                // é”™è¯¯çŠ¶æ€
                if (fileItem) {
                    fileItem.style.background = '#f8d7da';
                    fileItem.innerHTML = `
                        <span style="font-size: 12px;">âŒ ${file.name}</span>
                        <span style="color: #721c24; font-size: 11px;">ç½‘ç»œé”™è¯¯</span>
                    `;
                }
                return { success: false, filename: file.name };
            });
        });

        // ç­‰å¾…æ‰€æœ‰ä¸Šä¼ å®Œæˆ
        try {
            const results = await Promise.all(uploadPromises);
            const successCount = results.filter(r => r.success).length;
            const failCount = results.filter(r => !r.success).length;

            btn.disabled = false;
            btn.textContent = 'å¼€å§‹ä¸Šä¼ ';
            
            if (successCount > 0) {
                showMessage('success', `æˆåŠŸä¸Šä¼  ${successCount} ä¸ªè§†é¢‘${failCount > 0 ? 'ï¼Œå¤±è´¥ ' + failCount + ' ä¸ª' : ''}`);
                
                // 3ç§’åæ¸…ç©ºæ–‡ä»¶åˆ—è¡¨å¹¶åˆ·æ–°ç±»åˆ«
                setTimeout(() => {
                    selectedFiles = [];
                    displayFileList();
                    loadCategories();
                }, 3000);
            } else {
                showMessage('error', 'æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œå¤§å°');
            }
        } catch (error) {
            btn.disabled = false;
            btn.textContent = 'å¼€å§‹ä¸Šä¼ ';
            showMessage('error', 'ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
        }
    });

    // åˆ†å‰²æ•°æ®é›†
    document.getElementById('split-btn').addEventListener('click', () => {
        const ratio = parseFloat(document.getElementById('split-ratio').value);
        const seed = parseInt(document.getElementById('split-seed').value);

        if (confirm(`ç¡®å®šè¦æŒ‰ç…§ ${(ratio * 100).toFixed(0)}% è®­ç»ƒé›†ã€${((1-ratio) * 100).toFixed(0)}% éªŒè¯é›†çš„æ¯”ä¾‹åˆ†å‰²æ•°æ®é›†å—ï¼Ÿ\n\næ­¤æ“ä½œä¼šæ¸…ç©ºç°æœ‰çš„è®­ç»ƒé›†å’ŒéªŒè¯é›†ï¼`)) {
            const btn = document.getElementById('split-btn');
            btn.disabled = true;
            btn.textContent = 'åˆ†å‰²ä¸­...';

            request('/api/dataset/split', {
                method: 'POST',
                body: JSON.stringify({
                    train_ratio: ratio,
                    seed: seed
                })
            }).then(result => {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ å¼€å§‹åˆ†å‰²';

                if (result.success) {
                    showMessage('success', result.message);
                    loadStats();
                } else {
                    showMessage('error', result.message);
                }
            });
        }
    });

    // æ¸…ç©ºä¸Šä¼ ç›®å½•
    document.getElementById('clear-uploads-btn').addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºä¸Šä¼ ç›®å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¼šåˆ é™¤æ‰€æœ‰ç±»åˆ«æ–‡ä»¶å¤¹å’Œè§†é¢‘ï¼\næ³¨æ„ï¼šå·²åˆ†å‰²çš„è®­ç»ƒé›†å’ŒéªŒè¯é›†ä¸ä¼šè¢«åˆ é™¤ã€‚')) {
            request('/api/dataset/clear_uploads', {
                method: 'POST'
            }).then(result => {
                if (result.success) {
                    showMessage('success', result.message);
                    loadCategories();
                } else {
                    showMessage('error', result.message);
                }
            });
        }
    });
</script>
{% endblock %}
