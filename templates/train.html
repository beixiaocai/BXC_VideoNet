{% extends "base.html" %}

{% block title %}æ¨¡å‹è®­ç»ƒ - BXC_VideoNet{% endblock %}

{% block content %}
<div class="card">
    <h2 class="card-title">ğŸ¯ è®­ç»ƒé…ç½®</h2>
    
    <div class="grid">
        <div class="form-group">
            <label class="form-label">è®­ç»ƒè½®æ•° (Epochs)</label>
            <input type="number" id="num-epochs" class="form-input" value="50" min="1">
        </div>
        
        <div class="form-group">
            <label class="form-label">æ‰¹æ¬¡å¤§å° (Batch Size)</label>
            <input type="number" id="batch-size" class="form-input" value="8" min="1">
        </div>
        
        <div class="form-group">
            <label class="form-label">å­¦ä¹ ç‡ (Learning Rate)</label>
            <input type="number" id="learning-rate" class="form-input" value="0.0005" step="0.0001" min="0.00001">
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">é¢„è®­ç»ƒæ¨¡å‹ï¼ˆå¯é€‰ï¼Œç”¨äºæ–­ç‚¹ç»­è®­æˆ–è¿ç§»å­¦ä¹ ï¼‰</label>
        <select id="pretrained-model" class="form-select">
            <option value="">ä»å¤´å¼€å§‹è®­ç»ƒ</option>
        </select>
    </div>

    <div style="display: flex; gap: 8px;">
        <button class="btn btn-success" id="start-train-btn">
            ğŸš€ å¼€å§‹è®­ç»ƒ
        </button>
        <button class="btn btn-danger" id="stop-train-btn" style="display: none;">
            â¹ï¸ åœæ­¢è®­ç»ƒ
        </button>
    </div>
</div>

<div class="card" id="training-status" style="display: none;">
    <h2 class="card-title">ğŸ“ˆ è®­ç»ƒè¿›åº¦</h2>
    
    <div class="progress">
        <div class="progress-bar" id="progress-bar" style="width: 0%;">0%</div>
    </div>

    <div style="margin-bottom: 12px; font-size: 12px;">
        <strong>å½“å‰è½®æ¬¡:</strong> <span id="current-epoch">0</span> / <span id="total-epochs">0</span>
    </div>

    <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
        <div class="grid-item">
            <h4 style="color: #667eea; margin-bottom: 6px; font-size: 12px;">è®­ç»ƒé›†</h4>
            <p style="font-size: 11px; margin: 3px 0;"><strong>æŸå¤±:</strong> <span id="train-loss">0.0000</span></p>
            <p style="font-size: 11px; margin: 3px 0;"><strong>å‡†ç¡®ç‡:</strong> <span id="train-acc">0.0000</span></p>
        </div>
        
        <div class="grid-item">
            <h4 style="color: #56ab2f; margin-bottom: 6px; font-size: 12px;">éªŒè¯é›†</h4>
            <p style="font-size: 11px; margin: 3px 0;"><strong>æŸå¤±:</strong> <span id="val-loss">0.0000</span></p>
            <p style="font-size: 11px; margin: 3px 0;"><strong>å‡†ç¡®ç‡:</strong> <span id="val-acc">0.0000</span></p>
        </div>
    </div>

    <div class="grid-item" style="margin-top: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 10px;">
        <h4 style="margin-bottom: 6px; font-size: 12px;">ğŸ† æœ€ä½³éªŒè¯å‡†ç¡®ç‡</h4>
        <p style="font-size: 24px; font-weight: bold; margin: 0;"><span id="best-acc">0.0000</span></p>
    </div>
</div>

<div class="card">
    <h2 class="card-title">ğŸ“‹ è®­ç»ƒæ—¥å¿—</h2>
    <div class="log-box" id="log-box">
        ç­‰å¾…è®­ç»ƒå¼€å§‹...
    </div>
</div>

<div class="card">
    <h2 class="card-title">ğŸ’¾ å·²ä¿å­˜çš„æ¨¡å‹</h2>
    <div id="model-list">
        <p style="text-align: center; color: #999; padding: 12px; font-size: 11px;">åŠ è½½ä¸­...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let trainingInterval = null;

    // é¡µé¢åŠ è½½æ—¶è·å–æ¨¡å‹åˆ—è¡¨
    window.addEventListener('load', () => {
        loadModels();
    });

    // åŠ è½½æ¨¡å‹åˆ—è¡¨
    function loadModels() {
        request('/api/models/list')
            .then(data => {
                const modelList = document.getElementById('model-list');
                const modelSelect = document.getElementById('pretrained-model');
                
                if (data.models.length === 0) {
                    modelList.innerHTML = '<p style="text-align: center; color: #999; padding: 12px; font-size: 11px;">æš‚æ— å·²ä¿å­˜çš„æ¨¡å‹</p>';
                    return;
                }

                // æ›´æ–°æ¨¡å‹åˆ—è¡¨
                let html = '<table class="table"><thead><tr><th>æ¨¡å‹åç§°</th><th>å¤§å°</th><th>åˆ›å»ºæ—¶é—´</th></tr></thead><tbody>';
                data.models.forEach(model => {
                    html += `<tr>
                        <td><strong>${model.name}</strong></td>
                        <td>${model.size}</td>
                        <td>${model.created}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                modelList.innerHTML = html;

                // æ›´æ–°é¢„è®­ç»ƒæ¨¡å‹é€‰æ‹©æ¡†
                modelSelect.innerHTML = '<option value="">ä»å¤´å¼€å§‹è®­ç»ƒ</option>';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });
            });
    }

    // å¼€å§‹è®­ç»ƒ
    document.getElementById('start-train-btn').addEventListener('click', () => {
        const numEpochs = parseInt(document.getElementById('num-epochs').value);
        const batchSize = parseInt(document.getElementById('batch-size').value);
        const learningRate = parseFloat(document.getElementById('learning-rate').value);
        const pretrainedModel = document.getElementById('pretrained-model').value;

        if (numEpochs < 1 || batchSize < 1 || learningRate <= 0) {
            showMessage('error', 'è¯·æ£€æŸ¥è®­ç»ƒå‚æ•°æ˜¯å¦æ­£ç¡®');
            return;
        }

        request('/api/train/start', {
            method: 'POST',
            body: JSON.stringify({
                num_epochs: numEpochs,
                batch_size: batchSize,
                learning_rate: learningRate,
                pretrained_model: pretrainedModel
            })
        }).then(result => {
            if (result.success) {
                showMessage('success', result.message);
                document.getElementById('start-train-btn').style.display = 'none';
                document.getElementById('stop-train-btn').style.display = 'inline-block';
                document.getElementById('training-status').style.display = 'block';
                
                // å¼€å§‹è½®è¯¢è®­ç»ƒçŠ¶æ€
                startPolling();
            } else {
                showMessage('error', result.message);
            }
        });
    });

    // åœæ­¢è®­ç»ƒ
    document.getElementById('stop-train-btn').addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦åœæ­¢è®­ç»ƒå—ï¼Ÿ')) {
            request('/api/train/stop', {
                method: 'POST'
            }).then(result => {
                if (result.success) {
                    showMessage('info', result.message);
                    stopPolling();
                }
            });
        }
    });

    // å¼€å§‹è½®è¯¢è®­ç»ƒçŠ¶æ€
    function startPolling() {
        if (trainingInterval) {
            clearInterval(trainingInterval);
        }

        trainingInterval = setInterval(() => {
            request('/api/train/status')
                .then(data => {
                    updateTrainingStatus(data);
                    
                    // å¦‚æœè®­ç»ƒå·²ç»“æŸ
                    if (!data.is_training) {
                        stopPolling();
                        document.getElementById('start-train-btn').style.display = 'inline-block';
                        document.getElementById('stop-train-btn').style.display = 'none';
                        loadModels();
                    }
                });
        }, 2000);  // æ¯2ç§’æ›´æ–°ä¸€æ¬¡
    }

    // åœæ­¢è½®è¯¢
    function stopPolling() {
        if (trainingInterval) {
            clearInterval(trainingInterval);
            trainingInterval = null;
        }
    }

    // æ›´æ–°è®­ç»ƒçŠ¶æ€
    function updateTrainingStatus(data) {
        document.getElementById('current-epoch').textContent = data.current_epoch;
        document.getElementById('total-epochs').textContent = data.total_epochs;
        document.getElementById('progress-bar').style.width = data.progress + '%';
        document.getElementById('progress-bar').textContent = data.progress + '%';
        
        document.getElementById('train-loss').textContent = data.train_loss.toFixed(4);
        document.getElementById('train-acc').textContent = data.train_acc.toFixed(4);
        document.getElementById('val-loss').textContent = data.val_loss.toFixed(4);
        document.getElementById('val-acc').textContent = data.val_acc.toFixed(4);
        document.getElementById('best-acc').textContent = data.best_acc.toFixed(4);

        // æ›´æ–°æ—¥å¿—
        if (data.log && data.log.length > 0) {
            const logBox = document.getElementById('log-box');
            logBox.innerHTML = data.log.map(log => `<div>${log}</div>`).join('');
            logBox.scrollTop = logBox.scrollHeight;
        }
    }

    // é¡µé¢å¸è½½æ—¶åœæ­¢è½®è¯¢
    window.addEventListener('beforeunload', () => {
        stopPolling();
    });
</script>
{% endblock %}
